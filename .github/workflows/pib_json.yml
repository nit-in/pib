name: PIB_JSON

on:
  workflow_dispatch:
    inputs:
      desc:
        description: 'Enter the appropriate data in the following sections'
        default: 'DO NOT EDIT THIS LEAVE THIS AS IS'
      
      month:
        description: 'Enter the ministry code(Find the ministry code from ministries.txt file)'
        required: true
        type: choice
        options:
        - "Jan"
        - "Feb"
        - "Mar"
        - "Apr"
        - "May"
        - "Jun"
        - "Jul"
        - "Aug"
        - "Sep"
        - "Oct"
        - "Nov"
        - "Dec"
        
      year:
        description: 'Year'
        required: true
        type: string

jobs:
  pib_articles:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      
    steps:
      - uses: actions/checkout@v4
      - name: setting_up
        env:
          ACTIONS_ALLOW_UNSECURE_COMMANDS: 'true'
        run: |
          echo "set man-db/auto-update false" | sudo debconf-communicate dpkg-reconfigure man-db
          sudo apt update
          sudo apt install --fix-missing -y python3 wkhtmltopdf fd-find poppler-utils
          sudo ln -s $(which fdfind) /usr/bin/fd
          sudo pip install -r requirements.txt --ignore-installed
          mkdir -p /home/runner/zips/{text,monthly,daily}
          mkdir -p /home/runner/pib/{article_links,articles,json_dir}
          sudo pip install -U pyopenssl cryptography --ignore-installed || echo "upgrade failed"

      - name: set env
        run:  |
          echo ${{ inputs.month }}
          echo ${{ inputs.year }}
          PIB_MONTH=${{ inputs.month }}
          PIB_YEAR=${{ inputs.year }}

      - name: run script
        run:  |
          source .env
          export ONLY_JSON="True"
          pib_month ${{ env.PIB_MONTH }} ${{ env.PIB_YEAR }} || err_handle "10" "Spider failed to run"

      - name: cat_json
        run:  |
          source .env
          cd /home/runner/pib/json_dir/
          ls -lah
          cat $(ls PIB_JSON_*_*_*.json | grep -v "^PIB_JSON_${{ env.PIB_MONTH }}_${{ env.PIB_YEAR }}.json$") > PIB_JSON_${{ env.PIB_MONTH }}_${{ env.PIB_YEAR }}.json || cat *.json >> PIB_JSON_${{ env.PIB_MONTH }}_${{ env.PIB_YEAR }}.json

      - name: Create json files
        uses: ncipollo/release-action@v1.14.0
        with:
          artifacts: "/home/runner/pib/json_dir/*.json"
          token: ${{ secrets.PIB }}
          tag: "PIB_JSON_${{ env.PIB_MONTH }}_${{ env.PIB_YEAR }}"
          allowUpdates: true
          body : "PIB articles json for the month of ${{ env.PIB_MONTH }}, ${{ env.PIB_YEAR }}"